name: Release Push

on:
  pull_request:
    types: [closed]

jobs:
  create-release:
    if: github.event.pull_request.merged && github.event.pull_request && startsWith(github.head_ref, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # è®¾ç½® pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      # è®¾ç½® Node.js ç¯å¢ƒï¼Œç‰ˆæœ¬ä¸º 18
      - uses: actions/setup-node@v4
        with:
          node-version: 18

      # è·å– pnpm çš„å­˜å‚¨ç›®å½•è·¯å¾„
      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "pnpm_cache_dir=$(pnpm store path)" >> $GITHUB_OUTPUT

      # è®¾ç½® pnpm ç¼“å­˜
      - uses: actions/cache@v4
        name: Setup pnpm cache
        with:
          # ç¼“å­˜è·¯å¾„
          path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
          # ç¼“å­˜é”®
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          # æ¢å¤ç¼“å­˜çš„å¤‡ç”¨é”®
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£…ä¾èµ–
      - run: pnpm i

      - name: Get latest release PR
        id: get-pr
        uses: actions/github-script@v6
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            console.log(`Looking for release PR for tag: ${tag}`);
            
            // æŸ¥æ‰¾ä»¥ 'release/' å¼€å¤´çš„åˆ†æ”¯çš„æœ€è¿‘åˆå¹¶çš„PR
            const query = `is:pr is:merged head:release/${tag} base:develop`;
            const searchResult = await github.rest.search.issuesAndPullRequests({
              q: query,
              sort: 'updated',
              order: 'desc',
              per_page: 1
            });
            
            if (searchResult.data.items.length === 0) {
              console.log('No matching PR found');
              return {
                pr_number: null,
                changelog: null
              };
            }
            
            const pr = searchResult.data.items[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);
            
            // è·å–PRè¯„è®ºï¼ŒæŸ¥æ‰¾changelog
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            let changelog = null;
            for (const comment of comments.data) {
              if (comment.body.startsWith('## ğŸŒˆ ')) {
                changelog = comment.body;
                break;
              }
            }
            
            return {
              pr_number: pr.number,
              changelog: changelog
            };

      - name: Read CHANGELOG.md
        id: read-changelog
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const tag = context.ref.replace('refs/tags/', '');
            
            try {
              const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
              const versionHeader = `## ${tag}`;
              const startIndex = changelog.indexOf(versionHeader);
              
              if (startIndex === -1) {
                console.log(`Version ${tag} not found in CHANGELOG.md`);
                return { content: null };
              }
              
              const nextVersionIndex = changelog.indexOf('## ', startIndex + 2);
              const releaseNotes = nextVersionIndex === -1
                ? changelog.slice(startIndex)
                : changelog.slice(startIndex, nextVersionIndex);
              
              return { content: releaseNotes.trim() };
            } catch (error) {
              console.error(`Error reading CHANGELOG.md: ${error}`);
              return { content: null };
            }

      - name: Build WESLEY version
        run: pnpm run open:build

      - name: Create WESLEY zip
        run: |
          VERSION=$(echo ${{ github.ref_name }} | sed 's/\./_/g' | sed 's/-/_/g')
          zip -r MTB-OA-WESLEY-BuildPackage-$VERSION.zip dist/*

      - name: Build HMH version
        run: pnpm run hmh:build

      - name: Create HMH zip
        run: |
          VERSION=$(echo ${{ github.ref_name }} | sed 's/\./_/g' | sed 's/-/_/g')
          zip -r MTB-OA-HMH-BuildPackage-$VERSION.zip dist/*

      - name: Build default version
        run: pnpm run build

      - name: Create default zip
        run: |
          VERSION=$(echo ${{ github.ref_name }} | sed 's/\./_/g' | sed 's/-/_/g')
          zip -r MTB-OA-BuildPackage-$VERSION.zip dist/*

      - name: Create Release
        uses: actions/github-script@v6
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const version = tag.replace(/\./g, '_').replace(/-/g, '_');
            
            // ä¼˜å…ˆä½¿ç”¨PRè¯„è®ºä¸­çš„changelogï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨CHANGELOG.mdä¸­çš„å†…å®¹
            let releaseBody = steps.get-pr.outputs.changelog;
            if (!releaseBody) {
              releaseBody = steps.read-changelog.outputs.content;
            }
            
            // å¦‚æœä»ç„¶æ²¡æœ‰changelogï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
            if (!releaseBody) {
              releaseBody = `Release ${tag}`;
            }
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆalphaæˆ–betaï¼‰
            const isPrerelease = tag.includes('-alpha.') || tag.includes('-beta.');
            
            // åˆ›å»ºrelease
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${tag}`,
              body: releaseBody,
              draft: false,
              prerelease: isPrerelease
            });

            // ä¸Šä¼ æ„å»ºåŒ…
            const fs = require('fs');
            const globby = require('globby');
            
            const assets = [
              `MTB-OA-WESLEY-BuildPackage-${version}.zip`,
              `MTB-OA-HMH-BuildPackage-${version}.zip`,
              `MTB-OA-BuildPackage-${version}.zip`
            ];
            
            for (const asset of assets) {
              if (fs.existsSync(asset)) {
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.data.id,
                  name: asset,
                  data: fs.readFileSync(asset)
                });
              }
            }
            
            console.log(`Created release for tag ${tag} with assets`);

      - name: Clean up
        if: always()
        run: |
          rm -f MTB-OA-*-BuildPackage-*.zip